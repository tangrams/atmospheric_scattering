<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Atmospheric Scattering</title>
        <!-- 3rd party libraries -->
            <!-- Leaflet -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css" />
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js"></script>
            <!-- bog-standard leaflet URL hash -->
            <script type="text/javascript" src="https://cdn.rawgit.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
            <!-- Main tangram library -->
            <script type="text/javascript" src="https://mapzen.com/tangram/0.10/tangram.min.js"></script>
            <!-- Load geocoding plugin after Leaflet -->
<!--             <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.1/leaflet-geocoder-mapzen.css">
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.1/leaflet-geocoder-mapzen.js"></script> -->

            <!-- GLSL Canvas -->
            <script type="text/javascript" src="src/GlslCanvas.js"></script>

            <!-- SunCalc -->
            <script type="text/javascript" src="src/suncalc.js"></script>
            <script type="text/javascript" src="src/starjs.min.js"></script>
            <script type="text/javascript" src="src/constellations-rey60.js"></script>
            <script type="text/javascript" src="src/starmap.js"></script>

        <!-- End of 3rd party libraries -->

        <style>
            body {
                margin: 0px;
                border: 0px;
                padding: 0px;
            }
            #map {
                background: rgba(0, 0, 0, 0);
                height: 100%;
                width: 100%;
                position: absolute;
            }
            #starmap {
                position: absolute;
                background-color: rgba(1, 1, 1, 0);
                z-index: 10000;
                top: 500px;
                right: 0px;
                visibility: hidden;
            }
            #atmosphere {
                position: absolute;
                background-color: rgba(1, 1, 1, 0);
                z-index: 10000;
                top: 0px;
                right: 0px;
            }

        </style>
    </head>
    <body>
        <canvas id="starmap" width="500" height="500"></canvas>
        <canvas id="atmosphere" data-fragment-url="shader.frag" width="500" height="500"></canvas>
        <div id="map"></div>

        <!-- Demo module -->
        <script type="text/javascript">
            var starmap = undefined;
            var atmosphere = undefined;

            var map = (function () {
                'use strict';

                var map_start_location = [-24.98,-62.53, 3.6];

                /*** URL parsing ***/

                // leaflet-style URL hash pattern:
                // ?style.yaml#[zoom],[lat],[lng]
                var url_hash = window.location.hash.slice(1).split('/');
                if (url_hash.length == 3) {
                    map_start_location = [url_hash[1],url_hash[2], url_hash[0]];
                    // convert from strings
                    map_start_location = map_start_location.map(Number);
                }

                var animated = true;
                var url_search = window.location.search.slice(1);
                if (url_search.length > 0) {
                    if (url_search.indexOf('animated=false') > -1) {
                        animated = false;
                    }
                }

                /*** Map ***/
                var map = L.map('map', {
                    maxZoom: 20,
                    trackResize: true,
                    keyboard: false
                });
                // L.control.geocoder('mapzen-YoRQaZF',{pointIcon: false, markers: false}).addTo(map);

                var layer = Tangram.leafletLayer({
                    scene: 'scene.yaml',
                    introspection: true,
                    attribution: '&copy; OSM contributors | <a href="https://mapzen.com" target="_blank">Mapzen</a>'
                });

                window.layer = layer;
                var scene = layer.scene;
                window.scene = scene;

                map.setView(map_start_location.slice(0, 2), map_start_location[2]);
                var hash = new L.Hash(map);

                // Resize map to window
                function resizeMap() {
                    document.getElementById('map').style.width = window.innerWidth + 'px';
                    document.getElementById('map').style.height = window.innerHeight + 'px';
                    map.invalidateSize(false);
                }

                window.addEventListener('resize', resizeMap);
                resizeMap();

                window.addEventListener('load', function () {
                    // Listen to when the user stop moving (`moveend`) the leaflet map
                    // Note: a debounce function is use to prevent multiple calls to OpenWeatherMaps api
                    map.on('move', update);

                    starmap = new StarMap("starmap", 500, REY_STARS60, [], {});

                    layer.addTo(map);
                    animate();
                });

                return map;
            }());

            //code before the pause
            setTimeout(function(){
                update();
                var prevPos = [0,0];
                atmosphere = new GlslCanvas(document.getElementById('atmosphere'));
                

                atmosphere.on("render", function() {
                    if (scene) {
                        var pos = [atmosphere.uniforms.u_sun.value[0][0],atmosphere.uniforms.u_sun.value[0][1]];
                        // If the position of the sun had change...
                        if (prevPos[0] !== pos[0] || prevPos[1] !== pos[1]) {
                            // Reload spheretexture from the shader for ambient
                            scene.loadTextures();

                            // UPDATE default_light LIGHT COLOR
                            prevPos = pos;
                            // Prevent the vector for going under the horizon
                            var vec = [pos[0]-.5,pos[1]-.5];
                            var angle = Math.atan2(vec[1],vec[0]);
                            var radius = Math.sqrt(vec[0]*vec[0] + vec[1]*vec[1]);
                            radius = Math.min(radius,.48);
                            pos = [(Math.cos(angle)*radius)+.5, (Math.sin(angle)*radius)+.5];
                            // Extract the pixel of where the sun is
                            var pixel = new Uint8Array(4);
                            var gl = atmosphere.gl;
                            gl.readPixels(  pos[0]*gl.drawingBufferWidth,
                                            pos[1]*gl.drawingBufferHeight,
                                            1,1, 
                                            gl.RGBA, gl.UNSIGNED_BYTE, pixel);
                            // Actually update the color of the light
                            scene.lights.default_light.diffuse = [pixel[0]/255,pixel[1]/255,pixel[2]/255];
                            // console.log("light color changed to ", pixel);
                        }
                    }
                })
            }, 2000);

             function dot(a,b) {
                var n = 0, lim = Math.min(a.length,b.length);
                for (var i = 0; i < lim; i++) n += a[i] * b[i];
                return n;
             }

            function update() {
                if (atmosphere) {
                    var loc = map.getCenter();
                    starmap.setPos(loc.lng, loc.lat,  new Date());
                    var sun = [0,0];
                    var moon = [,]
                    var visible = true;

                    if (starmap && starmap.bodies) {
                        if (starmap.bodies.sun.proj_pos) {
                            sun = [starmap.bodies.sun.proj_pos.x, 1.-starmap.bodies.sun.proj_pos.y];
                            visible = starmap.bodies.sun.proj_pos.visible;
                        }

                        if (starmap.bodies.moon.proj_pos) {
                            moon = [starmap.bodies.moon.proj_pos.x, 1.-starmap.bodies.moon.proj_pos.y];
                        }
                        
                    }


                    if (scene.lights && scene.lights.default_light) {
                        atmosphere.setUniform('u_sun', sun[0], sun[1]);
                        atmosphere.setUniform('u_moon', moon[0], moon[1]);
                        atmosphere.loadTexture('u_starts', starmap.paper);
                        atmosphere.setUniform('u_tex0', './moon.jpg');
                        atmosphere.render();

                        // If the SUN is visible...
                        if (scene.lights.default_light._direction && visible) {
                            sun = [sun[0]-.5,sun[1]-.5];
                            var vector = new StarJs.Vector.Vector3(sun[0], sun[1], Math.sqrt(Math.abs(1.0 - dot(sun,sun))) );
                            var normal = vector.scale(-1./vector.len());
                            scene.lights.default_light._direction = [normal.x,normal.y,normal.z];
                        }
                    } 
                    else {
                        atmosphere.setUniform('u_sun', 0.0, 0.0);
                        if (scene && scene.lights && scene.lights.default_light) {
                            scene.lights.default_light._direction = [.0,.0,.0];
                        }
                    }
                }
               
            }

            function animate() {
                update();
                setTimeout(animate, 15000);
            }

            // ============================================= Some Helper functions
            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };
            
        </script>

        <!-- Adding a script block to post message to the parent container (think iframed demos) -->
        <script type="text/javascript">
          window.addEventListener("hashchange",function(){parent.postMessage(window.location.hash, "*")});
        </script>

        <!-- Mapzen map UI -->
        <script src='//mapzen.com/common/ui/mapzen-ui.min.js'></script>
        <script>
          MPZN.bug();
        </script>
    </body>
</html>